name: Build and Remap Mod

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Clean workspace
      run: |
        rm -rf build/ .gradle/
        find . -name "*.class" -type f -delete
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Make gradlew executable
      run: chmod +x gradlew
      
    - name: Debug project structure
      run: |
        echo "=== é¡¹ç›®æ–‡ä»¶ ==="
        ls -la
        echo "=== æºä»£ç ç»“æ„ ==="
        find src -name "*.java" | head -10
        
    - name: Download dependencies
      run: ./gradlew dependencies --no-daemon
      
    - name: Compile Java
      run: ./gradlew compileJava --no-daemon --stacktrace
      
    - name: Process resources
      run: ./gradlew processResources --no-daemon
      
    - name: Build and Remap JAR
      run: |
        echo "=== å¼€å§‹é‡æ˜ å°„ ==="
        ./gradlew remapJar --no-daemon --stacktrace --info
        echo "=== é‡æ˜ å°„å®Œæˆ ==="
        
    - name: Analyze build results
      run: |
        echo "ğŸ“¦ ç”Ÿæˆçš„JARæ–‡ä»¶:"
        ls -la build/libs/
        echo ""
        echo "ğŸ” å¼€å‘ç‰ˆå†…å®¹:"
        jar tf build/libs/luckymod-1.0.0-dev.jar | grep -E "(net/|com/)" | head -3 || echo "æ— ç±»æ–‡ä»¶"
        echo ""
        echo "ğŸ” å‘å¸ƒç‰ˆå†…å®¹:"
        jar tf build/libs/luckymod-1.0.0.jar | grep -E "(net/|com/)" | head -3 || echo "æ— ç±»æ–‡ä»¶"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mod-files
        path: build/libs/
        retention-days: 7