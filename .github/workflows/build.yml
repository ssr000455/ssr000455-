name: Build Mod

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Smart clean and build
      run: |
        echo "ğŸ§¹ æ™ºèƒ½æ¸…ç†..."
        # åªæ¸…ç†å…³é”®ç¼“å­˜ï¼Œä¿ç•™ä¾èµ–
        rm -rf build/loom-cache/ build/devlibs/ build/libs/
        find . -name "*.class" -type f -delete
        
        echo "ğŸš€ å¼ºåˆ¶æ„å»º..."
        ./gradlew clean --rerun-tasks
        ./gradlew compileJava --rerun-tasks --no-build-cache
        ./gradlew processResources --rerun-tasks --no-build-cache
        ./gradlew remapJar --rerun-tasks --no-build-cache --stacktrace
        
    - name: Verify results
      run: |
        echo "=== æ„å»ºç»“æœ ==="
        ls -la build/libs/
        echo "=== å‘å¸ƒç‰ˆå†…å®¹ ==="
        jar tf build/libs/luckymod-1.0.0.jar | grep -E "^(net/|com/)" | head -5
        
    - uses: actions/upload-artifact@v4
      with:
        name: mod-files
        path: build/libs/