name: Build and Remap Mod

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Clean workspace
      run: |
        rm -rf build/ .gradle/
        find . -name "*.class" -type f -delete
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Make gradlew executable
      run: chmod +x gradlew
      
    - name: Debug project structure
      run: |
        echo "=== 项目文件 ==="
        ls -la
        echo "=== 源代码结构 ==="
        find src -name "*.java" | head -10
        
    - name: Download dependencies
      run: ./gradlew dependencies --no-daemon
      
    - name: Compile Java
      run: ./gradlew compileJava --no-daemon --stacktrace
      
    - name: Process resources
      run: ./gradlew processResources --no-daemon
      
    - name: Build and Remap JAR
      run: |
        echo "=== 开始重映射 ==="
        ./gradlew remapJar --no-daemon --stacktrace --info
        echo "=== 重映射完成 ==="
        
    - name: Analyze build results
      run: |
        echo "📦 生成的JAR文件:"
        ls -la build/libs/
        echo ""
        echo "🔍 开发版内容:"
        jar tf build/libs/luckymod-1.0.0-dev.jar | grep -E "(net/|com/)" | head -3 || echo "无类文件"
        echo ""
        echo "🔍 发布版内容:"
        jar tf build/libs/luckymod-1.0.0.jar | grep -E "(net/|com/)" | head -3 || echo "无类文件"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mod-files
        path: build/libs/
        retention-days: 7