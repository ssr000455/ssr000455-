name: Build Mod

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Clean and prepare
      run: |
        rm -rf build/ .gradle/
        chmod +x gradlew
        
    - name: Build with debug info
      run: |
        echo "=== 开始构建 ==="
        ./gradlew clean build --stacktrace --no-daemon
        
    - name: Debug build outputs
      run: |
        echo "=== 构建产物 ==="
        find build/ -name "*.jar" -type f | while read file; do
          echo "📦 $file"
          ls -la "$file"
        done
        echo "=== 检查重映射输入 ==="
        if [ -f build/libs/luckymod-1.0.0-dev.jar ]; then
          echo "✅ 找到dev jar文件"
          jar tf build/libs/luckymod-1.0.0-dev.jar | head -5
        else
          echo "❌ 未找到dev jar文件"
          # 手动修复：复制普通jar为dev jar
          if [ -f build/libs/luckymod-1.0.0.jar ]; then
            echo "🛠️ 手动创建dev jar"
            cp build/libs/luckymod-1.0.0.jar build/libs/luckymod-1.0.0-dev.jar
          fi
        fi
        
    - name: Force remap
      run: |
        echo "=== 强制执行重映射 ==="
        ./gradlew remapJar --stacktrace --no-daemon
        
    - name: Check final results
      run: |
        echo "=== 最终文件 ==="
        ls -la build/libs/
        echo ""
        echo "=== 发布版内容检查 ==="
        if [ -f build/libs/luckymod-1.0.0.jar ]; then
          jar tf build/libs/luckymod-1.0.0.jar | grep -E "(net/|com/)" | head -5
        fi
        
    - uses: actions/upload-artifact@v4
      with:
        name: mod-files
        path: build/libs/