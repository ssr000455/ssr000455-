name: Build Mod

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Clean and prepare
      run: |
        rm -rf build/ .gradle/
        chmod +x gradlew
        
    - name: Build with debug info
      run: |
        echo "=== å¼€å§‹æ„å»º ==="
        ./gradlew clean build --stacktrace --no-daemon
        
    - name: Debug build outputs
      run: |
        echo "=== æ„å»ºäº§ç‰© ==="
        find build/ -name "*.jar" -type f | while read file; do
          echo "ğŸ“¦ $file"
          ls -la "$file"
        done
        echo "=== æ£€æŸ¥é‡æ˜ å°„è¾“å…¥ ==="
        if [ -f build/libs/luckymod-1.0.0-dev.jar ]; then
          echo "âœ… æ‰¾åˆ°dev jaræ–‡ä»¶"
          jar tf build/libs/luckymod-1.0.0-dev.jar | head -5
        else
          echo "âŒ æœªæ‰¾åˆ°dev jaræ–‡ä»¶"
          # æ‰‹åŠ¨ä¿®å¤ï¼šå¤åˆ¶æ™®é€šjarä¸ºdev jar
          if [ -f build/libs/luckymod-1.0.0.jar ]; then
            echo "ğŸ› ï¸ æ‰‹åŠ¨åˆ›å»ºdev jar"
            cp build/libs/luckymod-1.0.0.jar build/libs/luckymod-1.0.0-dev.jar
          fi
        fi
        
    - name: Force remap
      run: |
        echo "=== å¼ºåˆ¶æ‰§è¡Œé‡æ˜ å°„ ==="
        ./gradlew remapJar --stacktrace --no-daemon
        
    - name: Check final results
      run: |
        echo "=== æœ€ç»ˆæ–‡ä»¶ ==="
        ls -la build/libs/
        echo ""
        echo "=== å‘å¸ƒç‰ˆå†…å®¹æ£€æŸ¥ ==="
        if [ -f build/libs/luckymod-1.0.0.jar ]; then
          jar tf build/libs/luckymod-1.0.0.jar | grep -E "(net/|com/)" | head -5
        fi
        
    - uses: actions/upload-artifact@v4
      with:
        name: mod-files
        path: build/libs/