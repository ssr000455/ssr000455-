name: Build Mod

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Smart clean and build
      run: |
        echo "🧹 智能清理..."
        # 只清理关键缓存，保留依赖
        rm -rf build/loom-cache/ build/devlibs/ build/libs/
        find . -name "*.class" -type f -delete
        
        echo "🚀 强制构建..."
        ./gradlew clean --rerun-tasks
        ./gradlew compileJava --rerun-tasks --no-build-cache
        ./gradlew processResources --rerun-tasks --no-build-cache
        ./gradlew remapJar --rerun-tasks --no-build-cache --stacktrace
        
    - name: Verify results
      run: |
        echo "=== 构建结果 ==="
        ls -la build/libs/
        echo "=== 发布版内容 ==="
        jar tf build/libs/luckymod-1.0.0.jar | grep -E "^(net/|com/)" | head -5
        
    - uses: actions/upload-artifact@v4
      with:
        name: mod-files
        path: build/libs/